<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>手势识别 (0-10)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* 视觉风格保持不变：纯黑极简 */
        body {
            background-color: #000000;
            color: #ffffff;
            margin: 0;
            padding: 0;
            height: 100vh; /* 兼容旧浏览器 */
            height: 100dvh; /* 兼容 iOS Safari 动态地址栏 */
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-user-select: none; /* 禁止 iOS 选中文字 */
            user-select: none;
        }

        /* 隐藏摄像头画面 */
        .input_video {
            position: absolute;
            width: 1px; height: 1px;
            opacity: 0; pointer-events: none;
        }

        /* 中央大数字样式 */
        #number-display {
            font-size: 40vw; /* 字体非常大 */
            font-weight: 700;
            opacity: 0;
            transform: scale(0.8);
            /* 平滑过渡动画 */
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            cursor: default;
        }

        /* 激活状态 */
        #number-display.active {
            opacity: 1;
            transform: scale(1);
        }

        /* 加载提示 */
        #loading {
            position: absolute; bottom: 40px;
            font-size: 14px; color: #666;
            text-align: center; width: 100%;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse { 0% {opacity:0.4} 50% {opacity:1} 100% {opacity:0.4} }
    </style>
</head>
<body>

    <video class="input_video" playsinline webkit-playsinline muted autoplay></video>

    <div id="number-display"></div>
    <div id="loading">正在启动双手识别引擎...<br><span style="font-size:12px">请允许相机权限</span></div>

    <script>
        const videoElement = document.getElementsByClassName('input_video')[0];
        const displayElement = document.getElementById('number-display');
        const loadingElement = document.getElementById('loading');
        
        let lastNumber = -1; // 用于防抖动

        // --- 核心逻辑修改区 开始 ---

        function onResults(results) {
            // 隐藏加载提示
            if(loadingElement.style.display !== 'none') loadingElement.style.display = 'none';

            // 检查是否检测到任何手
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                
                let totalFingers = 0;

                // 【关键修改】循环遍历所有检测到的手（可能是1只，也可能是2只）
                for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                    const landmarks = results.multiHandLandmarks[i];
                    // 获取对应这只手的标签（左手还是右手）用于辅助判断拇指
                    const handedness = results.multiHandedness[i].label;
                    
                    // 调用计算单手手指的函数，并累加到总数
                    totalFingers += countSingleHandFingers(landmarks, handedness);
                }
                
                // 更新屏幕显示总数
                updateDisplay(totalFingers);

            } else {
                // 没有检测到手，隐藏数字
                hideDisplay();
            }
        }

        // 这个函数只负责计算“一只手”伸出了几个手指 (逻辑不变)
        function countSingleHandFingers(landmarks, handLabel) {
            let count = 0;
            // 食指到小指的指尖和关节索引
            const tipsIds = [8, 12, 16, 20];
            const pipIds = [6, 10, 14, 18];

            // 判断食指到小指 (通过 Y 轴高度比较)
            for (let i = 0; i < 4; i++) {
                // 注意：画面坐标系中，Y轴向下是正方向。指尖比关节Y值小意味着手指是向上的。
                if (landmarks[tipsIds[i]].y < landmarks[pipIds[i]].y) {
                    count++;
                }
            }

            // 判断拇指 (通过 X 轴水平位置比较，依赖左右手标签)
            const thumbTip = landmarks[4].x;
            const thumbIP = landmarks[3].x;
            
            // MediaPipe 前置摄像头默认是镜像的。
            // 如果识别为 Right(画面左侧的手)，伸出时指尖X小于关节X。
            if (handLabel === 'Right') {
               if (thumbTip < thumbIP) count++;
            } else {
               // 如果识别为 Left(画面右侧的手)，伸出时指尖X大于关节X。
               if (thumbTip > thumbIP) count++;
            }

            return count;
        }
        // --- 核心逻辑修改区 结束 ---


        // 更新 UI 显示 (带简单的防抖)
        function updateDisplay(number) {
            if (number !== lastNumber) {
                lastNumber = number;
                displayElement.innerText = number;
                displayElement.classList.add('active');
            }
            // 确保动画类存在
            if (!displayElement.classList.contains('active')) {
                displayElement.classList.add('active');
            }
        }

        // 隐藏 UI
        function hideDisplay() {
            displayElement.classList.remove('active');
            // 延迟重置状态，让淡出动画完成
            setTimeout(() => {
                if(!displayElement.classList.contains('active')) {
                   lastNumber = -1;
                }
            }, 350);
        }

        // 初始化 MediaPipe Hands
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 2, // 【关键修改】这里改成了 2，允许识别两只手
            modelComplexity: 1, // 性能与精度的平衡模式
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        hands.onResults(onResults);

        // 初始化摄像头 (针对手机前置优化)
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720,
            facingMode: 'user' // 强制使用前置镜头
        });

        camera.start();
    </script>
</body>
</html>
